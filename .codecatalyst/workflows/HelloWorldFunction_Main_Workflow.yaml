Name: HelloWorldFunction_MainWorkflow
Compute:
  Type: EC2
  Fleet: Linux.x86-64.Large
  SharedInstance: true
SchemaVersion: "1.0"

# Optional - Set automatic triggers.
Triggers:
  - Type: Push
    Branches:
      - main

# Required - Define action configurations.
Actions:
  DeployAndTest:
    Actions:
      Deploy:
        Inputs:
          Sources:
            - WorkflowSource
        Identifier: aws/github-actions-runner@v1.0.0
        Outputs:
          Variables:
            - 'get_application_endpoint_url_ENDPOINT_URL'
        Configuration:
          Steps:
            - name: Deploy to Azure Functions
              uses: serverless/github-action@v3.2
              with:
                args: -c "serverless plugin install --name serverless-azure-functions &&
                  serverless deploy"
                entrypoint: /bin/sh
              env:
                AZURE_SUBSCRIPTION_ID: ${Secrets.SUBSCRIPTION_ID}
                AZURE_TENANT_ID: ${Secrets.TENANT_ID}
                AZURE_CLIENT_ID: ${Secrets.CLIENT_ID}
                AZURE_CLIENT_SECRET: ${Secrets.CLIENT_SECRET}
            - name: Install Azure CLI
              id: install_azure_cli
              run: |
                rpm --import https://packages.microsoft.com/keys/microsoft.asc
                sh -c 'echo -e "[azure-cli]
                name=Azure CLI
                baseurl=https://packages.microsoft.com/yumrepos/azure-cli
                enabled=1
                gpgcheck=1
                gpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
                yum install azure-cli -y
            - name: Login To Azure
              id: login_to_azure
              uses: azure/login@v1
              with:
                creds: '{"clientId":"${Secrets.CLIENT_ID}","clientSecret":"${Secrets.CLIENT_SECRET}","subscriptionId":"${Secrets.SUBSCRIPTION_ID}","tenantId":"${Secrets.TENANT_ID}"}'
            - name: Get Application Endpoint
              id: get_application_endpoint_url
              run: |
                ENDPOINT_URL=$(az functionapp list --query "[?contains(name,'sls')].defaultHostName" --output tsv)
                echo "ENDPOINT_URL=$ENDPOINT_URL" >> $GITHUB_OUTPUT
      Test:
        Identifier: aws/managed-test@v1.0.0
        Configuration:
          Steps:
            - Run: |
                if curl ${Deploy.get_application_endpoint_url_ENDPOINT_URL}/api/goodbye?name=CodeCatalyst; then
                    echo "Application Endpoint is reachable"
                else
                    echo "Application Endpoint is not reachable"
                fi

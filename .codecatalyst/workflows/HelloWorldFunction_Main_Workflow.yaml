Name: HelloWorldFunction_MainWorkflow
Compute:
  Type: EC2
  Fleet: Linux.x86-64.Large
  SharedInstance: true
SchemaVersion: "1.0"

# Optional - Set automatic triggers.
Triggers:
  - Type: Push
    Branches:
      - main

# Required - Define action configurations.
Actions:
  DeployAndTest:
    Actions:
      Deploy:
        Inputs:
         Sources:
          - WorkflowSource
        Identifier: aws/github-actions-runner@v1.0.0
        Configuration:
          Steps:
            - name: Deploy to Azure Functions
              uses: serverless/github-action@v3.2
              with:
                args: -c "serverless plugin install --name serverless-azure-functions && serverless deploy"
                entrypoint: /bin/sh
              env: 
                AZURE_SUBSCRIPTION_ID: ${Secrets.SUBSCRIPTION_ID}
                AZURE_TENANT_ID: ${Secrets.TENANT_ID}
                AZURE_CLIENT_ID: ${Secrets.CLIENT_ID}
                AZURE_CLIENT_SECRET: ${Secrets.CLIENT_SECRET}    
            - name: Install Azure CLI
              run: |
                rpm --import https://packages.microsoft.com/keys/microsoft.asc
                sh -c 'echo -e "[azure-cli]
                name=Azure CLI
                baseurl=https://packages.microsoft.com/yumrepos/azure-cli
                enabled=1
                gpgcheck=1
                gpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
                yum install azure-cli -y
            - name: Login To Azure
              id: login-to-azure
              uses: azure/login@v1
              with:
                creds: '{"clientId":"${Secrets.CLIENT_ID}","clientSecret":"${Secrets.CLIENT_SECRET}","subscriptionId":"${Secrets.SUBSCRIPTION_ID}","tenantId":"${Secrets.TENANT_ID}"}'
            - name: Get Application Endpoint
              run: |
                printf '%q\n' "${PWD##*/}"
                az functionapp list --query "[?contains(name,'sls')].defaultHostName" --output tsv
